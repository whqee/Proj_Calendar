C51 COMPILER V9.59.0.0   MAIN                                                              04/01/2019 21:26:52 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\A\Keil_MDK5.25\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listin
                    -gs\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <common.h>
   2          #include <lcd1602.h>
   3          #include <ds1302.h>
   4          <<<<<<< HEAD
*** ERROR C141 IN LINE 4 OF main.c: syntax error near '<<', expected 'hdata'
   5          =======
*** ERROR C129 IN LINE 5 OF main.c: missing ';' before '=='
   6          
   7          #define BCD_TO_BIN(val)   ( (((val) >> 4) * 10) +  ((val)&15) )    // Applicable to 8 'bit data length
   8          #define BIN_TO_BCD(val)   ( (((val)/10) << 4) + (((val)%10)) )     // Applicable to 8 'bit data length
   9          >>>>>>> dev
  10          
  11          sbit KEY0 = P3^2;
  12          sbit KEY1 = P3^3;
  13          
  14          // Variable definition:
  15          u8 i = 0, xdata tmp;  // temporary 'data
  16          static u8 xdata count = 0;  // running flag for KEY0_Line Interrupt 0
  17          static u8 xdata pm = 0;  // define for am pm
  18          static u8 xdata Enable_12_hour_display = 0xff;
  19          static char xdata time_now[7];
  20          static char time_ascii[14];
  21          
  22          //functions prototype:
  23          static void print_time();
  24          void check_time();
  25          void update_time_for_set_time(u8 x,u8 y,u8 t,u8 count_copy);
  26          void delay_50ms();
  27          
  28          
  29          void main()
  30          {
  31            EA = 0; // Disable Interrupt
  32            lcd1602_Init(); 
  33            
  34            /** KEY_Init: Set KEY0 Interrupt **/
  35            IT0 = 1;      // KEY0 Falling edge trigger
  36            IT1 = 1;      // KEY1 Falling edge trigger
  37            EX0 = 1;      // Enable KEY0 Interrupt line
  38            EX1 = 0;
  39            EA = 1;       // Enable Interrupt
  40            /** End setting KEY0 Interrupt **/
  41            
  42            while(1)
  43            {
  44              Normal_Running:
  45              if(count)
  46                goto Set_Time;
  47              
  48              ds1302_read_time(time_now);
  49          <<<<<<< HEAD
  50          =======
  51              check_time();
  52          >>>>>>> dev
C51 COMPILER V9.59.0.0   MAIN                                                              04/01/2019 21:26:52 PAGE 2   

  53              print_time();
  54            }
  55            while(1)
  56            {
  57              Set_Time:
  58              if(!count)
  59                goto Normal_Running;
  60          
  61              while (count) {
  62                switch (count) {
  63                case 1:
  64                  tmp = BCD_TO_BIN(time_now[count-1]);
  65                  if (KEY1 == 0) {
  66                    tmp++;
  67                    if (tmp > 59) tmp = 0;  //modify here         1
  68                    time_now[count-1] = BIN_TO_BCD(tmp);
  69                  }
  70                  update_time_for_set_time(6,1,5,count);   // Modify here  2
  71                  break;
  72                case 2:
  73                  tmp = BCD_TO_BIN(time_now[count-1]);
  74                  if (KEY1 == 0) {
  75                    tmp++;
  76                    if (tmp > 59) tmp = 0;  //modify here         1
  77                    time_now[count-1] = BIN_TO_BCD(tmp);
  78                  }
  79                  update_time_for_set_time(3,1,5,count);   // Modify here  2
  80                  break;
  81                case 3:
  82                  tmp = BCD_TO_BIN(time_now[count-1]);
  83                  if (KEY1 == 0) {
  84                    tmp++;
  85                    if (tmp > 23) tmp = 0;  //modify here          1
  86                    time_now[count-1] = BIN_TO_BCD(tmp);
  87                  }
  88                  if (Enable_12_hour_display) {
  89                    if (BCD_TO_BIN(time_now[2]) > 12 ) {
  90                      tmp = BIN_TO_BCD(BCD_TO_BIN(time_now[2]) - 12);
  91                      lcd1602_show_str(0,1, &tmp, 2);
  92                    } else
  93                    {
  94                      lcd1602_show_str(0,1, &tmp, 2);
  95                    }
  96                  }
  97                  update_time_for_set_time(0,1,5,count);   // Modify here  2
  98                  break;
  99                case 4:
 100                  tmp = BCD_TO_BIN(time_now[count-1]);
 101                  if (KEY1 == 0) {
 102                    tmp++;
 103                    if (tmp > 7) tmp = 1; //modify here             1 
 104                    time_now[count-1] = BIN_TO_BCD(tmp);
 105                  }
 106                  // update display'
 107                  EA = 0; // Disable Interrupt
 108                  lcd1602_show_str(10,0, "  ", 2);  // modify here (x,y)           2
 109                  for(i=2; i > 0; i--) delay_50ms();
 110                  time_ascii[2*count-1] = time_now[count-1] & 63 | 48;    // BCD TO ASCII.
 111                  time_ascii[2*count-2] = time_now[count-1] >>4 &63 | 48; // BCD TO ASCII.
 112                  switch ((time_now[3] & 15)) {             //modify here  (x,y)                 3-8
 113                  case 1:
 114                    lcd1602_show_str(11,0, "1 Mon", 5); break;
C51 COMPILER V9.59.0.0   MAIN                                                              04/01/2019 21:26:52 PAGE 3   

 115                  case 2:
 116                    lcd1602_show_str(11,0, "2 Tue", 5); break;
 117                  case 3:
 118                    lcd1602_show_str(11,0, "3 Wed", 5); break;
 119                  case 4:
 120                    lcd1602_show_str(11,0, "4 Thu", 5); break;
 121                  case 5:
 122                    lcd1602_show_str(11,0, "5 Fri", 5); break;
 123                  case 6:
 124                    lcd1602_show_str(11,0, "6 Sat", 5); break;
 125                  case 7:
 126                    lcd1602_show_str(11,0, "7 Sun", 5); break;
 127                  default:
 128                    lcd1602_show_str(11,0, "error", 5);
 129                    break;
 130                  }
 131                  EA = 1;   //Enable Interrupt
 132                  for(i=2; i > 0; i--) delay_50ms();
 133                  break;
 134                case 5:
 135                  tmp = BCD_TO_BIN(time_now[count-1]);
 136                  if (KEY1 == 0) {
 137                    tmp++;
 138                    if (tmp > 31) tmp = 1;  //modify here                 1
 139                    time_now[count-1] = BIN_TO_BCD(tmp);
 140                  }
 141                  update_time_for_set_time(8,0,5,count);   // Modify here  2
 142                  break;
 143                case 6:
 144                  tmp = BCD_TO_BIN(time_now[count-1]);
 145                  if (KEY1 == 0) {
 146                    tmp++;
 147                    if (tmp > 12) tmp = 1;  //modify here            1
 148                    time_now[count-1] = BIN_TO_BCD(tmp);
 149                  }
 150                  update_time_for_set_time(5,0,5,count);   // Modify here  2
 151                  break;
 152                case 7:
 153                  tmp = BCD_TO_BIN(time_now[count-1]);
 154                  if (KEY1 == 0) {
 155                    tmp++;
 156                    if (tmp > 99) tmp = 0;     // modify here         1
 157                    time_now[count-1] = BIN_TO_BCD(tmp);
 158                  }
 159                  update_time_for_set_time(2,0,5,count);   // Modify here  2
 160                  break;
 161                case 8:
 162                  if (KEY1 == 0) Enable_12_hour_display = ~Enable_12_hour_display;
 163                  if (Enable_12_hour_display) {
 164                    if (pm) {
 165                      lcd1602_show_str(9,1, "pm", 2);
 166                    } else
 167                    {
 168                      lcd1602_show_str(9,1, "am", 2);
 169                    }
 170                  } else
 171                  {
 172                    lcd1602_show_str(9,1, "  ", 2);
 173                  }
 174                  
 175                  for(i=4; i > 0; i--) delay_50ms();
 176                  lcd1602_show_str(9,1, "  ", 2);
C51 COMPILER V9.59.0.0   MAIN                                                              04/01/2019 21:26:52 PAGE 4   

 177                  for(i=4; i > 0; i--) delay_50ms();
 178                  break;
 179                default:
 180                  lcd1602_show_str(11,0, "error", 5);
 181                  break;
 182                }
 183              }
 184              ds1302_set_time(time_now);
 185            }
 186            
 187          }
 188          
 189          
 190          void print_time()
 191          {
 192            u8 j = 7, x = 2, y =0;
 193            lcd1602_show_str(0,0, "20", 2);
 194            while(j--)
 195            {
 196              // BCD_TO_ASCII
 197              time_ascii[2*j+1] = time_now[j] & 63 | 48;
 198              time_ascii[2*j] = time_now[j] >>4 &63 | 48;
 199          
 200              // print: year.mon.date
 201              if (j > 3) {
 202                lcd1602_show_str(x,y, &time_ascii[2*j], 2);
 203                x += 2;
 204                if (x > 8) 
 205                  lcd1602_show_str(x,y, " ", 1);
 206                else
 207                  lcd1602_show_str(x,y, ".", 2);
 208                x += 1;
 209          
 210                
 211              }
 212          
 213              //print: day
 214              if (j == 3) {
 215                switch ((time_now[j] & 15)) {
 216                case 1:
 217                  lcd1602_show_str(x,y, "1 Mon", 5); break;
 218                case 2:
 219                  lcd1602_show_str(x,y, "2 Tue", 5); break;
 220                case 3:
 221                  lcd1602_show_str(x,y, "3 Wed", 5); break;
 222                case 4:
 223                  lcd1602_show_str(x,y, "4 Thu", 5); break;
 224                case 5:
 225                  lcd1602_show_str(x,y, "5 Fri", 5); break;
 226                case 6:
 227                  lcd1602_show_str(x,y, "6 Sat", 5); break;
 228                case 7:
 229                  lcd1602_show_str(x,y, "7 Sun", 5); break;
 230                default:
 231                  ds1302_set_time_once(j, 1);
 232                  lcd1602_show_str(x,y, "error", 5);
 233                  break;
 234                }
 235                x = 0;
 236                y = 1;
 237              }
 238              
C51 COMPILER V9.59.0.0   MAIN                                                              04/01/2019 21:26:52 PAGE 5   

 239              // print: hours:min:sec
 240              if (j < 3) {
 241                lcd1602_show_str(x,y, &time_ascii[2*j], 2);
 242                x += 2;
 243                if (x < 6)
 244                  lcd1602_show_str(x,y, ":", 1);
 245                x += 1;       
 246              }
 247              
 248              
 249            }
 250            // lcd1602_print(time_ascii);
 251            
 252          }
 253          
 254          
 255          void check_time()
 256          {
 257            if (BCD_TO_BIN(time_now[5]) ==  4 | 6 | 8 | 11 && BCD_TO_BIN(time_now[4] > 30)) {
 258                time_now[4] = 1;
 259                time_now[5] += 1;
 260                ds1302_set_time_once(5, time_now[5]);
 261                ds1302_set_time_once(4, time_now[4]);
 262            }
 263            if (BCD_TO_BIN(time_now[5]) == 2 && BCD_TO_BIN(time_now[4] > 28)) {
 264              if (! BCD_TO_BIN(time_now[6]) % 4) {
 265                time_now[4] = 1;
 266                time_now[5] += 1;
 267                ds1302_set_time_once(5, time_now[5]);
 268                ds1302_set_time_once(4, time_now[4]);
 269              }
 270            }
 271            if (Enable_12_hour_display) {
 272              if (BCD_TO_BIN(time_now[2]) > 12 ) {
 273                pm = 1;
 274                time_now[2] = BIN_TO_BCD(BCD_TO_BIN(time_now[2]) - 12);
 275                lcd1602_show_str(9,1, "pm", 2);
 276              } else
 277              {
 278                lcd1602_show_str(9,1, "am", 2);
 279              }
 280            }
 281          }
 282          
 283          
 284          void update_time_for_set_time(u8 x,u8 y,u8 t,u8 count_copy)
 285          {
 286            // update display
 287            EA = 0; // Disable Interrupt
 288            lcd1602_show_str(x,y, "  ", 2);  // modify here (x,y)          2
 289            for(i = t; i > 0; i--) delay_50ms();
 290            time_ascii[2*count_copy-1] = time_now[count_copy-1] & 63 | 48;    // BCD TO ASCII.
 291            time_ascii[2*count_copy-2] = time_now[count_copy-1] >>4 &63 | 48; // BCD TO ASCII.
 292            lcd1602_show_str(x,y, &time_ascii[2*count_copy-2], 2); // modify here (x,y)           3
 293            EA = 1;   //Enable Interrupt
 294            for(i = t; i > 0; i--) delay_50ms();
 295          }
 296          
 297          
 298          void delay_50ms()
 299          {
 300            unsigned char a,b,c;
C51 COMPILER V9.59.0.0   MAIN                                                              04/01/2019 21:26:52 PAGE 6   

 301              for(c=1;c>0;c--)
 302                  for(b=38;b>0;b--)
 303                      for(a=130;a>0;a--);
 304          }
 305          
 306          void KEY_Line() interrupt 0
 307          {
 308            u8 i = 0;
 309            delay_50ms(); //  Be adopted to prevent dithering and repeated actions
 310            if (KEY0 == 0) {
 311              if(!count)
 312                count = 8;
 313              else 
 314                count--;
 315          
 316              for(i=11; i > 0; i--)
 317                delay_50ms();
 318            }
 319          }
 320          
 321          

C51 COMPILATION COMPLETE.  0 WARNING(S),  2 ERROR(S)
